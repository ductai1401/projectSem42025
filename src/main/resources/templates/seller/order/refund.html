<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{admin/_layoutAdmin}">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Refund Management</title>

<style>
/* Modern Design System */
:root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --warning-gradient: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
    --card-shadow: 0 5px 20px rgba(0,0,0,0.08);
    --card-shadow-hover: 0 10px 30px rgba(0,0,0,0.15);
}

/* Header Section */
.page-header-modern {
    background: var(--danger-gradient);
    padding: 30px;
    border-radius: 15px;
    color: white;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(250, 112, 154, 0.3);
}

.page-header-modern h1 {
    margin: 0;
    font-weight: 700;
    font-size: 2rem;
}

/* Stats Cards */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: var(--card-shadow);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
}

.stat-card.warning::before { background: var(--warning-gradient); }
.stat-card.info::before { background: var(--info-gradient); }
.stat-card.success::before { background: var(--success-gradient); }
.stat-card.primary::before { background: var(--primary-gradient); }

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--card-shadow-hover);
}

.stat-card .stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    margin-bottom: 15px;
}

.stat-card.warning .stat-icon { background: var(--warning-gradient); color: white; }
.stat-card.info .stat-icon { background: var(--info-gradient); color: white; }
.stat-card.success .stat-icon { background: var(--success-gradient); color: white; }
.stat-card.primary .stat-icon { background: var(--primary-gradient); color: white; }

.stat-card h5 {
    font-size: 0.9rem;
    color: #666;
    margin-bottom: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-card .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #333;
}

/* Modern Tabs */
.nav-tabs-modern {
    background: white;
    border-radius: 15px;
    padding: 10px;
    box-shadow: var(--card-shadow);
    border: none;
    margin-bottom: 25px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.nav-tabs-modern .nav-item {
    margin: 0;
    flex: 1;
    min-width: 130px;
}

.nav-tabs-modern .nav-link {
    border: none;
    border-radius: 10px;
    padding: 12px 15px;
    text-align: center;
    font-weight: 600;
    font-size: 0.85rem;
    color: #666;
    transition: all 0.3s ease;
    background: transparent;
    white-space: nowrap;
}

.nav-tabs-modern .nav-link:hover {
    background: #f6f8fb;
    color: #667eea;
    transform: translateY(-2px);
}

.nav-tabs-modern .nav-link.active {
    background: var(--danger-gradient);
    color: white;
    box-shadow: 0 5px 15px rgba(250, 112, 154, 0.3);
}

.nav-tabs-modern .nav-link i {
    margin-right: 6px;
}

/* Filter Card */
.filter-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: var(--card-shadow);
    margin-bottom: 25px;
}

.filter-card .form-control,
.filter-card .form-select {
    border: 2px solid #e8e8e8;
    border-radius: 10px;
    padding: 12px 18px;
    transition: all 0.3s ease;
}

.filter-card .form-control:focus,
.filter-card .form-select:focus {
    border-color: #fa709a;
    box-shadow: 0 0 0 0.2rem rgba(250, 112, 154, 0.15);
}

/* Modern Table */
.table-card {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: var(--card-shadow);
    overflow: hidden;
}

.table-modern {
    margin: 0;
    border-collapse: separate;
    border-spacing: 0;
}

.table-modern thead {
    background: linear-gradient(135deg, #f6f8fb 0%, #ffffff 100%);
}

.table-modern thead th {
    border: none;
    padding: 15px;
    font-weight: 700;
    color: #333;
    text-transform: uppercase;
    font-size: 0.85rem;
    letter-spacing: 0.5px;
}

.table-modern tbody tr {
    transition: all 0.3s ease;
    border-bottom: 1px solid #f0f0f0;
}

.table-modern tbody tr:hover {
    background: #f6f8fb;
    transform: scale(1.01);
    box-shadow: 0 3px 10px rgba(0,0,0,0.05);
}

.table-modern tbody td {
    padding: 18px 15px;
    vertical-align: middle;
    border: none;
}

/* Status Badges */
.status-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
}

.badge-pending {
    background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
    color: white;
}

.badge-approved {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    color: white;
}

.badge-rejected {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    color: white;
}

.badge-waiting {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
}

.badge-returning {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.badge-refunded {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    color: white;
}

/* Action Buttons */
.btn-action {
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.85rem;
    transition: all 0.3s ease;
    border: none;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.btn-action:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.btn-view {
    background: var(--info-gradient);
    color: white;
}

.btn-update {
    background: var(--success-gradient);
    color: white;
}

.btn-action:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none !important;
}

/* Modal Styling */
.modal {
    z-index: 9999 !important;
}

.modal-backdrop {
    z-index: 9998 !important;
}

.modal-content {
    border-radius: 15px;
    border: none;
    box-shadow: 0 10px 50px rgba(0,0,0,0.3);
}

.modal-header {
    background: var(--danger-gradient);
    color: white;
    border-radius: 15px 15px 0 0;
    padding: 20px 30px;
    border: none;
}

.modal-header .btn-close {
    filter: brightness(0) invert(1);
}

.modal-body {
    padding: 30px;
    max-height: 70vh;
    overflow-y: auto;
}

.modal-body::-webkit-scrollbar {
    width: 8px;
}

.modal-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
}

.modal-body::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 10px;
}

.modal-footer {
    border-top: 1px solid #f0f0f0;
    padding: 20px 30px;
}

/* Form Styling in Modal */
.form-group label {
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
}

.form-control,
.form-select {
    border: 2px solid #e8e8e8;
    border-radius: 10px;
    padding: 12px 18px;
    transition: all 0.3s ease;
}

.form-control:focus,
.form-select:focus {
    border-color: #fa709a;
    box-shadow: 0 0 0 0.2rem rgba(250, 112, 154, 0.15);
}

.form-check {
    background: #f6f8fb;
    padding: 15px;
    border-radius: 10px;
    border: 2px solid #e8e8e8;
    transition: all 0.3s ease;
}

.form-check:hover {
    border-color: #fa709a;
}

.form-check-input {
    width: 20px;
    height: 20px;
    margin-top: 0;
}

.form-check-input:checked {
    background-color: #fa709a;
    border-color: #fa709a;
}

/* Pagination */
.pagination-modern {
    display: flex;
    justify-content: center;
    gap: 8px;
    padding: 20px 0;
}

.pagination-modern .page-item {
    margin: 0;
}

.pagination-modern .page-link {
    border: 2px solid #e8e8e8;
    border-radius: 10px;
    padding: 10px 16px;
    color: #fa709a;
    font-weight: 600;
    transition: all 0.3s ease;
    min-width: 45px;
    text-align: center;
}

.pagination-modern .page-link:hover {
    background: var(--danger-gradient);
    color: white;
    border-color: transparent;
    transform: translateY(-2px);
}

.pagination-modern .page-item.active .page-link {
    background: var(--danger-gradient);
    color: white;
    border-color: transparent;
    box-shadow: 0 5px 15px rgba(250, 112, 154, 0.3);
}

/* Empty State */
.no-data {
    text-align: center;
    padding: 60px 20px;
    background: white;
    border-radius: 15px;
    box-shadow: var(--card-shadow);
}

.no-data i {
    font-size: 5rem;
    color: #e8e8e8;
    margin-bottom: 20px;
}

.no-data h5 {
    color: #666;
    margin-bottom: 10px;
}

.no-data p {
    color: #999;
}

/* Media Gallery */
.media-gallery {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 10px;
    margin-top: 15px;
}

.media-item {
    position: relative;
    border-radius: 10px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s ease;
    aspect-ratio: 1;
}

.media-item:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.media-item img,
.media-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Responsive */
@media (max-width: 768px) {
    .page-header-modern h1 {
        font-size: 1.5rem;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .nav-tabs-modern .nav-item {
        min-width: 100px;
    }
    
    .table-card {
        padding: 15px;
        overflow-x: auto;
    }
    
    .btn-action {
        padding: 6px 12px;
        font-size: 0.8rem;
    }
}

/* Animation */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.animate-fade-in {
    animation: fadeIn 0.6s ease;
}

/* Loading State */
.loading-spinner {
    width: 50px;
    height: 50px;
    border: 4px solid #f0f0f0;
    border-top-color: #fa709a;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>
</head>
<body>
	<div layout:fragment="content">
		<div class="container-fluid py-4">

			<!-- Header -->
			<div class="page-header-modern animate-fade-in">
				<h1><i class="bi bi-arrow-counterclockwise me-3"></i>Refund Management</h1>
				<p class="mb-0 opacity-75">Manage refund requests and returns</p>
			</div>

			<!-- Statistics -->
			<div class="stats-grid animate-fade-in">
				<div class="stat-card warning">
					<div class="stat-icon">
						<i class="bi bi-clock-history"></i>
					</div>
					<h5>Pending Requests</h5>
					<div class="stat-value" id="stat-pending">0</div>
					<small class="text-muted">Waiting for review</small>
				</div>

				<div class="stat-card info">
					<div class="stat-icon">
						<i class="bi bi-receipt-cutoff"></i>
					</div>
					<h5>Total Refunds</h5>
					<div class="stat-value" id="stat-total">0</div>
					<small class="text-muted">All time</small>
				</div>

				<div class="stat-card success">
					<div class="stat-icon">
						<i class="bi bi-cash-stack"></i>
					</div>
					<h5>Total Amount</h5>
					<div class="stat-value" id="stat-amount">0đ</div>
					<small class="text-muted">Refunded</small>
				</div>

				<div class="stat-card primary">
					<div class="stat-icon">
						<i class="bi bi-percent"></i>
					</div>
					<h5>Approval Rate</h5>
					<div class="stat-value" id="stat-rate">0%</div>
					<small class="text-muted">Success rate</small>
				</div>
			</div>

			<!-- Tabs -->
			<ul class="nav nav-tabs-modern animate-fade-in" id="orderTabs">
				<li class="nav-item">
					<a class="nav-link active" data-status="ALL" href="#">
						<i class="bi bi-list-ul"></i>All
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-status="PENDING" href="#">
						<i class="bi bi-clock"></i>Pending
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-status="APPROVED" href="#">
						<i class="bi bi-check-circle"></i>Approved
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-status="WAITING_FOR_RETURN" href="#">
						<i class="bi bi-hourglass-split"></i>Waiting Return
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-status="RETURNING" href="#">
						<i class="bi bi-truck"></i>Returning
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-status="RETURNED" href="#">
						<i class="bi bi-box-seam"></i>Returned
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-status="PROCESSING_REFUND" href="#">
						<i class="bi bi-gear"></i>Processing
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-status="REFUNDED" href="#">
						<i class="bi bi-check-all"></i>Refunded
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-status="REJECTED" href="#">
						<i class="bi bi-x-circle"></i>Rejected
					</a>
				</li>
			</ul>

			<!-- Filters -->
			<div class="filter-card animate-fade-in">
				<div class="row g-3">
					<div class="col-md-4">
						<label><i class="bi bi-search me-2"></i>Search</label>
						<input id="searchBox" class="form-control" type="text"
							placeholder="Order ID, Customer name..." />
					</div>
					<div class="col-md-3">
						<label><i class="bi bi-credit-card me-2"></i>Payment</label>
						<select id="paymentFilter" class="form-select">
							<option value="">All Methods</option>
							<option value="COD">COD</option>
							<option value="VNPAY">VNPAY</option>
						</select>
					</div>
					<div class="col-md-3">
						<label><i class="bi bi-calendar me-2"></i>Date</label>
						<input id="dateFilter" class="form-control" type="date" />
					</div>
					<div class="col-md-2">
						<label><i class="bi bi-list-ol me-2"></i>Per Page</label>
						<select id="pageSize" class="form-select">
							<option value="5">5 / page</option>
							<option value="10" selected>10 / page</option>
							<option value="20">20 / page</option>
						</select>
					</div>
				</div>
			</div>

			<!-- Table -->
			<div class="table-card animate-fade-in">
				<div class="table-responsive">
					<table class="table table-modern">
						<thead>
							<tr>
								<th><i class="bi bi-hash me-2"></i>Refund ID</th>
								<th><i class="bi bi-person me-2"></i>Customer</th>
								<th><i class="bi bi-cash me-2"></i>Amount</th>
								<th><i class="bi bi-chat-text me-2"></i>Reason</th>
								<th><i class="bi bi-calendar-check me-2"></i>Request Date</th>
								<th><i class="bi bi-calendar-event me-2"></i>Process Date</th>
								<th><i class="bi bi-flag me-2"></i>Status</th>
								<th class="text-center"><i class="bi bi-gear me-2"></i>Actions</th>
							</tr>
						</thead>
						<tbody id="refundsContainer">
							<!-- JS will render rows -->
						</tbody>
					</table>
				</div>
			</div>

			<!-- Empty State -->
			<div id="noData" class="no-data animate-fade-in" style="display: none;">
				<i class="bi bi-inbox"></i>
				<h5>No Refund Requests</h5>
				<p>There are no refund requests matching your filters</p>
			</div>

			<!-- Pagination -->
			<nav aria-label="Page navigation">
				<ul class="pagination pagination-modern" id="pagination"></ul>
			</nav>

		</div>

		<!-- Detail Modal -->
		<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog modal-lg modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">
							<i class="bi bi-receipt me-2"></i>Refund Details <span id="detailOrderCode"></span>
						</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body">
						<div id="detailContainer">
							<div class="text-center py-5">
								<div class="loading-spinner"></div>
								<p class="mt-3 text-muted">Loading...</p>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Media Preview Modal -->
		<div class="modal fade" id="mediaModal" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered modal-lg">
				<div class="modal-content">
					<div class="modal-body p-0 text-center">
						<img id="mediaImage" src="" style="max-width: 100%; display: none; border-radius: 15px;" />
						<video id="mediaVideo" controls style="max-width: 100%; display: none; border-radius: 15px;"></video>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-action btn-update" data-bs-dismiss="modal">
							<i class="bi bi-x-circle me-1"></i>Close
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Update Status Modal -->
		<div class="modal fade" id="updateModal" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<form id="updateForm">
						<div class="modal-header">
							<h5 class="modal-title">
								<i class="bi bi-pencil-square me-2"></i>Update Status <span id="updateOrderCode"></span>
							</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
						</div>

						<div class="modal-body">
							<input type="hidden" id="updateOrderId" name="refundId" />

							<div class="form-group mb-3">
								<label for="newStatus">
									<i class="bi bi-flag me-2"></i>New Status
								</label>
								<select class="form-select" id="newStatus" name="status">
									<option value="">-- Select Status --</option>
									<option value="PROCESSING_REFUND">Processing Refund</option>
									<option value="REFUNDED">Refunded</option>
									<option value="REJECTED">Rejected</option>
								</select>
							</div>

							<div class="form-group mb-3">
								<div class="form-check">
									<input type="checkbox" class="form-check-input" id="requestReturn" 
										   name="requestReturn" value="true">
									<label class="form-check-label" for="requestReturn">
										<i class="bi bi-box-arrow-in-left me-2"></i>Request Return Product
									</label>
								</div>
							</div>

							<div class="form-group">
								<label for="updateNote">
									<i class="bi bi-chat-text me-2"></i>Note
								</label>
								<textarea id="updateNote" name="note" class="form-control" rows="3"
									placeholder="Add a note about this refund..."></textarea>
							</div>
						</div>

						<div class="modal-footer">
							<button type="submit" class="btn btn-action btn-update">
								<i class="bi bi-check-circle me-1"></i>Update
							</button>
							<button type="button" class="btn btn-action btn-view" id="cancelBtn">
								<i class="bi bi-x-circle me-1"></i>Cancel
							</button>
						</div>
					</form>
				</div>
			</div>
		</div>

	</div>

	<div layout:fragment="scripts">
		<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
		<script th:inline="javascript">
        $(document).ready(function () {
            let currentStatus = 'ALL';
            let pageSize = parseInt($('#pageSize').val()) || 10;
            let currentPage = 1;
            
            const statusTransitions = {
                "PENDING": ["APPROVED", "REJECTED"],
                "APPROVED": ["WAITING_FOR_RETURN", "REJECTED"],
                "WAITING_FOR_RETURN": ["RETURNING", "REJECTED"],
                "RETURNING": ["RETURNED"],
                "RETURNED": ["PROCESSING_REFUND"],
                "PROCESSING_REFUND": ["REFUNDED", "REJECTED"],
                "REFUNDED": [],
                "REJECTED": []
            };

            function loadOrders(page = 1) {
                $('#refundsContainer').html(`
                    <tr>
                        <td colspan="8" class="text-center py-5">
                            <div class="loading-spinner"></div>
                            <p class="mt-3 text-muted">Loading refunds...</p>
                        </td>
                    </tr>
                `);

                $.ajax({
                    url: '/seller/loadDataRefund',
                    method: 'GET',
                    data: {
                        page: page,
                        size: pageSize,
                        keyword: $('#searchBox').val(),
                        date: $('#dateFilter').val(),
                        status: currentStatus,
                        payment: $('#paymentFilter').val()
                    },
                    success: function(res) {
                        renderData(res.refunds);
                        renderPagination(res.totalPages, res.page, pageSize);
                        updateStats(res.stats);
                    },
                    error: function(err) {
                        console.error('Load data failed:', err);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: 'Failed to load refunds'
                        });
                    }
                });
            }

            function renderData(refunds) {
                const $container = $('#refundsContainer');
                $container.empty();

                if (!refunds || refunds.length === 0) {
                    $('#noData').show();
                    $('.table-card').hide();
                    return;
                }

                $('#noData').hide();
                $('.table-card').show();

                const statusMap = {
                    PENDING: { text: 'PENDING', class: 'badge-pending', icon: 'clock' },
                    SHOP_APPROVED: { text: 'APPROVED', class: 'badge-approved', icon: 'check-circle' },
                    SHOP_REJECTED: { text: 'REJECTED', class: 'badge-rejected', icon: 'x-circle' },
                    WAITING_FOR_RETURN: { text: 'WAITING RETURN', class: 'badge-waiting', icon: 'hourglass-split' },
                    RETURNING: { text: 'RETURNING', class: 'badge-returning', icon: 'truck' },
                    RETURNED: { text: 'RETURNED', class: 'badge-approved', icon: 'box-seam' },
                    PROCESSING_REFUND: { text: 'PROCESSING', class: 'badge-pending', icon: 'gear' },
                    REFUNDED: { text: 'REFUNDED', class: 'badge-refunded', icon: 'check-all' }
                };

                refunds.forEach(refund => {
                    const status = statusMap[refund.status] || { text: 'Unknown', class: 'badge-secondary', icon: 'question-circle' };
                    const canUpdate = (refund.status === 'PENDING' || refund.status === 'RETURNING');
                    
                    const updateButton = canUpdate 
                        ? `<button class="btn btn-action btn-update action-update" data-id="${refund.refundId}">
                               <i class="bi bi-pencil"></i>Update
                           </button>` 
                        : `<button class="btn btn-action btn-update" disabled>
                               <i class="bi bi-pencil"></i>Update
                           </button>`;

                    const tr = `
                        <tr data-id="${refund.refundId}" data-status="${refund.status}">
                            <td><strong>${refund.refundId}</strong></td>
                            <td>
                                <div>
                                    <i class="bi bi-person-circle me-2" style="font-size: 1.5rem; color: #fa709a;"></i>
                                    <strong>${refund.buyerName}</strong>
                                </div>
                                <small class="text-muted">${refund.buyerPhone}</small>
                            </td>
                            <td><strong class="text-danger">${refund.amount.toLocaleString('vi-VN')} VND</strong></td>
                            <td><span class="badge bg-light text-dark">${refund.reason}</span></td>
                            <td>${refund.createdAt ? formatDate(refund.createdAt) : '-'}</td>
                            <td>${refund.processDate ? formatDate(refund.processDate) : '<span class="text-muted">Not processed</span>'}</td>
                            <td>
                                <span class="status-badge ${status.class}">
                                    <i class="bi bi-${status.icon}"></i>
                                    ${status.text}
                                </span>
                            </td>
                            <td class="text-center">
                                <div class="d-flex gap-2 justify-content-center">
                                    <button class="btn btn-action btn-view action-view" data-id="${refund.refundId}">
                                        <i class="bi bi-eye"></i>View
                                    </button>
                                    ${updateButton}
                                </div>
                            </td>
                        </tr>
                    `;
                    $container.append(tr);
                });
            }

            function formatDate(dt) {
                const d = new Date(dt);
                return d.toLocaleDateString('vi-VN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            function renderPagination(totalPages, page, size) {
                const $pagination = $('#pagination');
                $pagination.empty();

                if (totalPages <= 1) return;

                if (page > 1) {
                    $pagination.append(`
                        <li class="page-item">
                            <a class="page-link" href="#" data-page="${page - 1}">
                                <i class="bi bi-chevron-left"></i>
                            </a>
                        </li>
                    `);
                }

                const maxButtons = 7;
                let start = Math.max(1, page - Math.floor(maxButtons / 2));
                let end = Math.min(totalPages, start + maxButtons - 1);
                if (end - start < maxButtons - 1) start = Math.max(1, end - maxButtons + 1);

                for (let p = start; p <= end; p++) {
                    $pagination.append(`
                        <li class="page-item ${p === page ? 'active' : ''}">
                            <a class="page-link" href="#" data-page="${p}">${p}</a>
                        </li>
                    `);
                }

                if (page < totalPages) {
                    $pagination.append(`
                        <li class="page-item">
                            <a class="page-link" href="#" data-page="${page + 1}">
                                <i class="bi bi-chevron-right"></i>
                            </a>
                        </li>
                    `);
                }
            }

            function updateStats(stats) {
                if (!stats) return;
                $('#stat-pending').text(stats.pending || 0);
                $('#stat-total').text(stats.total || 0);
                $('#stat-amount').text((stats.amount || 0).toLocaleString('vi-VN') + 'đ');
                $('#stat-rate').text((stats.rate || 0) + '%');
            }

            // Events
            loadOrders(1);

            $('#orderTabs .nav-link').on('click', function(e) {
                e.preventDefault();
                $('#orderTabs .nav-link').removeClass('active');
                $(this).addClass('active');
                currentStatus = $(this).data('status');
                loadOrders(1);
            });

            $('#searchBox, #paymentFilter, #dateFilter, #pageSize').on('input change', function() {
                pageSize = parseInt($('#pageSize').val()) || 10;
                loadOrders(1);
            });

            $(document).on('click', '#pagination a.page-link', function(e) {
                e.preventDefault();
                const p = parseInt($(this).data('page'));
                if (!isNaN(p) && p >= 1) loadOrders(p);
            });
            
            // View detail
            $(document).on('click', '.action-view', function() {
                const id = $(this).data('id');
                $('#detailContainer').html(`
                    <div class="text-center py-5">
                        <div class="loading-spinner"></div>
                        <p class="mt-3 text-muted">Loading refund details...</p>
                    </div>
                `);

                $.get('/seller/refund/' + id, function(html){
                    $('#detailContainer').html(html);
                    $('#detailModal').modal('show');
                }).fail(function(){
                    $('#detailContainer').html(`
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Failed to load refund details. Please try again.
                        </div>
                    `);
                });
            });

            // Update modal
            $(document).on('click', '.action-update', function () {
                const id = $(this).data('id');
                const $row = $(`#refundsContainer tr[data-id="${id}"]`);
                const code = $row.attr('data-code');
                const currentStatus = $row.attr('data-status');

                $('#updateOrderId').val(id);
                $('#updateOrderCode').text(code ? (' - ' + code) : '');
                $('#updateNote').val('');
                $('#requestReturn').prop('checked', false);

                $('#updateNote').closest('.form-group').hide();
                $('#requestReturn').closest('.form-group').hide();
                $('#updateNote').removeAttr('required');

                const $select = $('#newStatus');
                $select.empty().append(`<option value="">-- Select Status --</option>`);
                const nextStatuses = statusTransitions[currentStatus] || [];

                if (nextStatuses.length === 0) {
                    $select.append(`<option disabled>Cannot update</option>`);
                    $('#updateForm button[type="submit"]').prop('disabled', true);
                } else {
                    nextStatuses.forEach(st => {
                        $select.append(`<option value="${st}">${st}</option>`);
                    });
                    $('#updateForm button[type="submit"]').prop('disabled', false);
                }

                $select.off('change').on('change', function () {
                    const newStatus = $(this).val();

                    $('#updateNote').closest('.form-group').hide();
                    $('#requestReturn').closest('.form-group').hide();
                    $('#updateNote').removeAttr('required');

                    if (currentStatus === 'PENDING' && newStatus === 'APPROVED') {
                        $('#requestReturn').closest('.form-group').show();
                    } else if (currentStatus === 'PENDING' && newStatus === 'REJECTED') {
                        $('#updateNote').closest('.form-group').show();
                        $('#updateNote').attr('required', true);
                    }
                });

                $('#updateModal').modal('show');
            });

            // Submit update
            $('#updateForm').on('submit', function (e) {
                e.preventDefault();
                const id = $('#updateOrderId').val();
                const newStatus = $('#newStatus').val();
                const note = $('#updateNote').val().trim();
                const requestReturn = $('#requestReturn').is(':checked');

                if (!newStatus) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Warning!',
                        text: 'Please select new status'
                    });
                    return;
                }

                if (newStatus === 'REJECTED' && !note) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Warning!',
                        text: 'You must enter a note when rejecting'
                    });
                    return;
                }

                Swal.fire({
                    title: 'Processing...',
                    text: 'Updating refund status',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                $.ajax({
                    url: '/seller/refund/' + id + '/status',
                    method: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        status: newStatus,
                        note: note,
                        requestReturn: (newStatus === 'APPROVED') ? requestReturn : false
                    }),
                    success: function (res) {
                        $('#updateModal').modal('hide');
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: res.message || 'Refund status updated successfully',
                            timer: 2000,
                            showConfirmButton: false
                        }).then(() => {
                            loadOrders(currentPage);
                        });
                    },
                    error: function () {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error!',
                            text: 'Failed to update refund status'
                        });
                    }
                });
            });
            
            // Media modal
            function showMediaModal(url) {
                const isImage = url.match(/\.(jpg|jpeg|png|gif)$/i);
                const isVideo = url.match(/\.(mp4|webm|ogg)$/i);

                if (isImage) {
                    $('#mediaImage').attr('src', url).show();
                    $('#mediaVideo').hide().attr('src', '');
                } else if (isVideo) {
                    $('#mediaVideo').attr('src', '/uploads/' + url).show();
                    $('#mediaImage').hide().attr('src', '');
                } else {
                    $('#mediaImage').hide();
                    $('#mediaVideo').hide();
                }

                $('#mediaModal').modal('show');
            }
            
            $(document).on('click', '.media-item', function () {
                const url = $(this).data('url');
                
                showMediaModal(url);
            });
            
            $('#cancelBtn').on('click', function () {
                $('#updateModal').modal('hide');
            });
        });
        </script>
	</div>
</body>
</html>