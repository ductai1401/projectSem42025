<!DOCTYPE html>
<html xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:th="http://www.thymeleaf.org"
	layout:decorate="~{client/client_layout/_layoutClient}">
<head>
<meta charset="UTF-8">
<title>Seller Center</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" th:href="@{/client/assets/mycss/sellerstyle.css}" />
</head>

<body>
<div layout:fragment="content" style="border-top: 2px solid red;">
	 <div class="check-out-section section-padding-bottom">
     <div class="container">
         <div class="row">
					<div class="col-lg-7">
						<div class="billing-info-wrap">
							<h3 class="title">Register to sell</h3>
							
							<form class="personal-information"
								id="registerSellerForm" >
								<div class="row">
									<div class="col-lg-12">
										<div class="billing-info mb-5">
											<label>Shop Name</label> <input type="text"
												name="shop.shopName" id="shopName" >
											  <div class="text-danger" id="error-shopName"></div>		
										</div>
									</div>
									<!-- <div class="col-lg-6 col-md-6">
										<div class="billing-info mb-5">
											<label>Email</label> <input type="text" name="user.email"
												readonly th:value="${user.email}">
										</div>
										
									</div> -->
									<div class="col-lg-12">
										<div class="billing-info mb-5">
											<label>Phone</label> 
											
											<input type="text" name="user.phoneNumber" th:value="${user.phoneNumber}" readonly 
										           id="phoneNumber" th:if="${user.phoneNumber != null and user.phoneNumber != ''}">
										    
										    <!-- Nếu chưa có số điện thoại, cho nhập -->
										    <input type="text" name="user.phoneNumber" th:value="${user.phoneNumber}" 
										           th:unless="${user.phoneNumber != null and user.phoneNumber != ''}"
										           id="phoneNumber">
										           <div class="text-danger" id="error-phone"></div>	
										</div>
									</div>

									<div class="additional-info-wrap">
										<div class="additional-info">
											<label class="mb-2">Description</label>
											<textarea
												placeholder="Notes about your order, e.g. special notes for delivery. "
												name="shop.description" id="description"></textarea>
											<div class="text-danger" id="error-description"></div>	
										</div>
									</div>

								</div>

								<div class="row">
									<!-- Warehouse Address -->
									<div class="col-lg-12">
										<h5>Warehouse Address</h5>
										<div class="row">
											<div class="col-lg-4">
												<label for="provinceKho">Region/City/District</label> <select
													id="provinceKho" name="address.provinceId"
													class="form-select mb-3">
													<option value="">-- Select Province/City --</option>
												</select> 
												<div class="text-danger" id="error-provinceId"></div>
												<input type="hidden" id="provinceName"
													name="address.provinceName">
													
											</div>
											<div class="col-lg-4">
												<label for="districtKho">District</label> <select
													id="districtKho" name="address.districtId"
													class="form-select mb-3" disabled>
													<option value="">-- Select District --</option>
												</select>
												<div class="text-danger" id="error-districtId"></div>
												 <input type="hidden" id="districtName"
													name="address.districtName">
											</div>
											<div class="col-lg-4">
												<label for="wardKho">Ward/Commune</label> <select
													id="wardKho" name="address.wardCode"
													class="form-select mb-3" disabled>
													<option value="">-- Select Ward/Commune --</option>
												</select> 
												<div class="text-danger" id="error-wardCode"></div>
												<input type="hidden" id="wardName" name="address.wardName">
											</div>
											<div class="col-lg-12">
												<label for="addressKho">House number, street name</label> <input
													id="addressKho" type="text" class="form-control mb-3"
													placeholder="Enter house number, street name"
													name="address.street">
													 <div class="text-danger" id="error-street"></div>
											</div>
										</div>
									</div>
									
								</div>
								
								<div class="row">
									<div class="col-lg-12">
										<button class="btn btn-dark form-control mb-3" type="submit">
											register</button>

									</div>
								</div>
							</form>
						</div>
					</div>

				</div>
     </div>
 </div>
 <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function () {
	
	
	  // Hàm load tỉnh cho 1 select
	  function loadProvinces(selector) {
	    $.ajax({
	      url: "/api/ghn/provinces",
	      method: "GET",
	      dataType: "json",
	      success: function (data) {
	        if (typeof data === "string") {
	          data = JSON.parse(data);
	        }
	        let provinces = Array.isArray(data) ? data : data.data || [];
	        let $select = $(selector);
	        $select.empty().append('<option value="">-- Select Province/City --</option>');
	        provinces.forEach(p => {
	          $select.append(`<option value="${p.ProvinceID}">${p.ProvinceName}</option>`);
	        });
	      }
	    });
	  }

	  // Hàm load huyện theo tỉnh cho 1 select
	  function loadDistricts(provinceId, selector) {
	    let $select = $(selector);
	    $select.empty().append('<option value="">-- Select District --</option>').prop("disabled", true);
	    if (!provinceId) return;
	    $.ajax({
	      url: "/api/ghn/districts",
	      method: "POST",
	      dataType: "json",
	      data: { provinceId: provinceId },
	      success: function (data) {
	        if (typeof data === "string") {
	          data = JSON.parse(data);
	        }
	        let districts = Array.isArray(data) ? data : data.data || [];
	        $select.empty().append('<option value="">-- Select District --</option>');
	        districts.forEach(d => {
	          $select.append(`<option value="${d.DistrictID}">${d.DistrictName}</option>`);
	        });
	        $select.prop("disabled", false);
	      }
	    });
	  }

	  // Hàm load xã theo huyện cho 1 select
	  function loadWards(districtId, selector) {
	    let $select = $(selector);
	    $select.empty().append('<option value="">-- Select Ward / Commune --</option>').prop("disabled", true);
	    if (!districtId) return;
	    $.ajax({
	      url: "/api/ghn/wards",
	      method: "POST",
	      dataType: "json",
	      data: { districtId: districtId },
	      success: function (data) {
	        if (typeof data === "string") {
	          data = JSON.parse(data);
	        }
	        let wards = Array.isArray(data) ? data : data.data || [];
	        $select.empty().append('<option value="">-- Select Ward/Commune --</option>');
	        wards.forEach(w => {
	          $select.append(`<option value="${w.WardCode}">${w.WardName}</option>`);
	        });
	        $select.prop("disabled", false);
	      }
	    });
	  }

	  // Load tỉnh cho tất cả các select province
	  loadProvinces("#provinceKho");

	  // Sự kiện thay đổi tỉnh
	  $("#provinceKho").change(function () {
	    let provinceId = $(this).val();
	    loadDistricts(provinceId, "#districtKho");
	    $("#wardKho").empty().append('<option value="">-- Select Ward / Commune --</option>').prop("disabled", true);
	  });
	  

	  // Sự kiện thay đổi huyện
	  $("#districtKho").change(function () {
	    let districtId = $(this).val();
	    loadWards(districtId, "#wardKho");
	  });
	 
	  
	  $("#provinceKho").change(function () {
		    let provinceId = $(this).val();
		    let provinceName = $("#provinceKho option:selected").text();
		    $("#provinceName").val(provinceName);
		    loadDistricts(provinceId, "#districtKho");
		    $("#wardKho").empty().append('<option value="">-- Select Ward / Commune --</option>').prop("disabled", true);
		});

		$("#districtKho").change(function () {
		    let districtId = $(this).val();
		    let districtName = $("#districtKho option:selected").text();
		    $("#districtName").val(districtName);
		    loadWards(districtId, "#wardKho");
		});

		$("#wardKho").change(function () {
		    let wardName = $("#wardKho option:selected").text();
		    $("#wardName").val(wardName);
		});
		
		
		
		$("#registerSellerForm").on("submit", function (e) {
		    e.preventDefault();
		    $(".text-danger").text("");
		    // Thu thập dữ liệu
		    var data = {
		        user: {
		        	phoneNumber : $("#phoneNumber").val(),
		        }, // nếu cần gửi thông tin user thì thêm ở đây
		        shop: {
		            shopName: $("#shopName").val(),
		            description: $("#description").val()
		        },
		        address: {
		            provinceId: $("#provinceKho").val(),
		            districtId: $("#districtKho").val(),
		            wardCode: $("#wardKho").val(),
		            provinceName: $("#provinceName").val(),
		            districtName: $("#districtName").val(),
		            wardName: $("#wardName").val(),
		            street: $("#addressKho").val()
		        }
		    };

		    $.ajax({
		        url: "api/registerSeller/create",
		        type: "POST",
		        contentType: "application/json",
		        data: JSON.stringify(data),
		        success: function (res) {
		            if (res.success) {
		                window.location.href = res.redirectUrl;
		            }
		        },
		        error: function (xhr) {
		            var response = xhr.responseJSON;
		            if (response && response.errors) {
		                // Xóa lỗi cũ
		                

		                // Hiển thị lỗi
		                for (const key in response.errors) {
		                    if (key === "global") {
		                        $("#error-global").text(response.errors[key]);
		                    } else {
		                        $("#error-" + key).text(response.errors[key]);
		                    }
		                }
		            }
		        }
		    });
		});
	});
	
	
</script>
 </div>
 
 
 
</body>
</html>