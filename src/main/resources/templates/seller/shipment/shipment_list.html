<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{admin/_layoutSeller}">
<head>
    <title>Shipment Management - Seller</title>
</head>
<body>
<div layout:fragment="content">
    <div class="container-fluid py-4">
        <h2 class="mb-4"><i class="bi bi-box-seam me-2"></i>Shipment Management</h2>

        <!-- Quick Stats -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h6>Awaiting Confirmation</h6>
                        <h3 th:text="${pendingShipments}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-info text-white">
                    <div class="card-body text-center">
                        <h6>Preparing</h6>
                        <h3 th:text="${preparingShipments}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body text-center">
                        <h6>In Delivery</h6>
                        <h3 th:text="${shippingShipments}">0</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h6>Delivered</h6>
                        <h3 th:text="${completedShipments}">0</h3>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter & Search -->
        <div class="card mb-4">
            <div class="card-body">
                <form th:action="@{/seller/shipments}" method="get" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Order/Shipment ID</label>
                        <input type="text" name="keyword" class="form-control"
                               placeholder="ORDER... or SHIP...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <select name="status" class="form-select">
                            <option value="">All</option>
                            <option value="1">Awaiting Pickup</option>
                            <option value="2">Assigned</option>
                            <option value="3">Picking</option>
                            <option value="4">Picked</option>
                            <option value="5">Delivering</option>
                            <option value="6">Delivered</option>
                            <option value="7">Failed</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">From Date</label>
                        <input type="date" name="fromDate" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Shipments Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                        <tr>
                            <th>Order ID</th>
                            <th>Shipment ID</th>
                            <th>Recipient</th>
                            <th>Phone</th>
                            <th>Delivery Address</th>
                            <th>Status</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="shipment : ${shipments}" >
                            <td>
                                <a th:href="@{'/seller/orders/' + ${shipment.orderId}}"
                                   th:text="${shipment.orderId}">
                                    ORDER001
                                </a>
                            </td>
                            <td>
                                <strong th:text="${shipment.shipmentID}">SHIP001</strong>
                            </td>
                            <td th:text="${shipment.recipientName}">John Doe</td>
                            <td th:text="${shipment.recipientPhone}">0901234567</td>
                            <td>
                                <span th:text="${#strings.abbreviate(shipment.deliveryAddress, 40)}"
                                      th:title="${shipment.deliveryAddress}">
                                    123 Nguyen Hue...
                                </span>
                            </td>
                            <td>
                                <span class="badge" th:classappend="${shipment.statusClass}"
                                      th:text="${shipment.statusText}">
                                    Delivering
                                </span>
                            </td>
                            <td th:text="${#temporals.format(shipment.createdAt, 'dd/MM/yyyy')}">
                                24/10/2025
                            </td>
                            <td>
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-info"
                                            th:onclick="'viewShipmentSeller(\'' + ${shipment.shipmentID} + '\')'">
                                        <i class="bi bi-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-primary"
                                            th:if="${shipment.status == 1}"
                                            th:onclick="'prepareShipment(\'' + ${shipment.shipmentID} + '\')'">
                                        <i class="bi bi-check-circle"></i> Prepare
                                    </button>
                                    <button class="btn btn-sm btn-success"
                                            th:if="${shipment.status == 3}"
                                            th:onclick="'handoverShipment(\'' + ${shipment.shipmentID} + '\')'">
                                        <i class="bi bi-hand-thumbs-up"></i> Handover
                                    </button>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <nav th:if="${totalPages > 1}">
                    <ul class="pagination justify-content-center mt-3">
                        <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                            <a class="page-link" th:href="@{/seller/shipments(page=${currentPage - 1})}">Previous</a>
                        </li>
                        <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                            th:classappend="${i == currentPage} ? 'active'">
                            <a class="page-link" th:href="@{/seller/shipments(page=${i})}" th:text="${i + 1}">1</a>
                        </li>
                        <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                            <a class="page-link" th:href="@{/seller/shipments(page=${currentPage + 1})}">Next</a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>

    <!-- View Shipment Detail Modal (Seller) -->
    <div class="modal fade" id="viewShipmentSellerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Shipment Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2 mb-3">Order Information</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td width="40%"><strong>Order ID:</strong></td>
                                    <td id="sellerOrderId"></td>
                                </tr>
                                <tr>
                                    <td><strong>Shipment ID:</strong></td>
                                    <td id="sellerShipmentId"></td>
                                </tr>
                                <tr>
                                    <td><strong>Shipper:</strong></td>
                                    <td id="sellerShipperName"></td>
                                </tr>
                                <tr>
                                    <td><strong>Status:</strong></td>
                                    <td id="sellerStatus"></td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="border-bottom pb-2 mb-3">Recipient Information</h6>
                            <table class="table table-sm">
                                <tr>
                                    <td width="40%"><strong>Full Name:</strong></td>
                                    <td id="sellerRecipientName"></td>
                                </tr>
                                <tr>
                                    <td><strong>Phone:</strong></td>
                                    <td id="sellerRecipientPhone"></td>
                                </tr>
                                <tr>
                                    <td><strong>Address:</strong></td>
                                    <td id="sellerDeliveryAddress"></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <div class="mb-3">
                        <h6 class="border-bottom pb-2 mb-3">Pickup Address</h6>
                        <p id="sellerPickupAddress"></p>
                    </div>

                    <div th:if="${showProofImages}">
                        <h6 class="border-bottom pb-2 mb-3">Proof of Delivery</h6>
                        <div id="sellerProofImages" class="d-flex gap-2">
                            <!-- Images will be loaded here -->
                        </div>
                    </div>

                    <hr>
                    <h6 class="mb-3">Shipment History</h6>
                    <div id="sellerShipmentHistory" class="timeline">
                        <!-- Timeline will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="printShipment()">
                        <i class="bi bi-printer"></i> Print Shipment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Prepare Shipment Modal -->
    <div class="modal fade" id="prepareShipmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Shipment Preparation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="prepareShipmentForm" method="post">
                    <div class="modal-body">
                        <input type="hidden" name="shipmentId" id="prepareShipmentId">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Confirm that your order is ready for pickup by the shipper.
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Note for Shipper</label>
                            <textarea name="notes" class="form-control" rows="3"
                                      placeholder="Example: Fragile items, handle with care..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Preferred Pickup Time</label>
                            <input type="datetime-local" name="preferredPickupTime" class="form-control">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Confirm</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Handover Shipment Modal -->
    <div class="modal fade" id="handoverShipmentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Shipment Handover</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="handoverShipmentForm" method="post">
                    <div class="modal-body">
                        <input type="hidden" name="shipmentId" id="handoverShipmentId">
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle me-2"></i>
                            Confirm that you have handed over the package to the shipper.
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Verification Code from Shipper</label>
                            <input type="text" name="verificationCode" class="form-control"
                                   placeholder="Enter verification code" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea name="notes" class="form-control" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Confirm Handover</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        // View Shipment Detail for Seller
        function viewShipmentSeller(shipmentId) {
            fetch('/seller/shipments/' + shipmentId + '/detail')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('sellerOrderId').textContent = data.orderId;
                    document.getElementById('sellerShipmentId').textContent = data.shipmentID;
                    document.getElementById('sellerShipperName').textContent = data.shipperName || 'Unassigned';
                    document.getElementById('sellerStatus').innerHTML = '<span class="badge ' + data.statusClass + '">' + data.statusText + '</span>';
                    document.getElementById('sellerRecipientName').textContent = data.recipientName;
                    document.getElementById('sellerRecipientPhone').textContent = data.recipientPhone;
                    document.getElementById('sellerDeliveryAddress').textContent = data.deliveryAddress;
                    document.getElementById('sellerPickupAddress').textContent = data.pickupAddress;

                    // Load history
                    let historyHtml = '';
                    data.history.forEach(h => {
                        historyHtml += `
                            <div class="timeline-item">
                                <small class="text-muted">${h.createdAt}</small>
                                <p class="mb-0"><strong>${h.statusText}</strong></p>
                                <small>${h.description || ''}</small>
                            </div>
                        `;
                    });
                    document.getElementById('sellerShipmentHistory').innerHTML = historyHtml;

                    new bootstrap.Modal(document.getElementById('viewShipmentSellerModal')).show();
                });
        }

        // Prepare Shipment
        function prepareShipment(shipmentId) {
            document.getElementById('prepareShipmentId').value = shipmentId;
            document.getElementById('prepareShipmentForm').action = '/seller/shipments/' + shipmentId + '/prepare';
            new bootstrap.Modal(document.getElementById('prepareShipmentModal')).show();
        }

        // Handover Shipment
        function handoverShipment(shipmentId) {
            document.getElementById('handoverShipmentId').value = shipmentId;
            document.getElementById('handoverShipmentForm').action = '/seller/shipments/' + shipmentId + '/handover';
            new bootstrap.Modal(document.getElementById('handoverShipmentModal')).show();
        }

        // Print Shipment
        function printShipment() {
            window.print();
        }
    </script>
</div>
</body>
</html>
