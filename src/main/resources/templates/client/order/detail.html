<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{client/client_layout/_layoutClient}">
<head>
    <title layout:fragment="title">Chi tiết đơn hàng</title>
    <style layout:fragment="css">
        .order-detail-page {
            background-color: #f5f5f5;
            padding: 20px 0;
        }
        
        .order-timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .order-timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #e0e0e0;
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -26px;
            top: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #fff;
            border: 3px solid #e0e0e0;
        }
        
        .timeline-item.active::before {
            border-color: #28a745;
            background: #28a745;
        }
        
        .timeline-item.current::before {
            border-color: #007bff;
            background: #007bff;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(0, 123, 255, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(0, 123, 255, 0);
            }
        }
        
        .product-item {
            border-bottom: 1px solid #e9ecef;
            padding: 15px 0;
            transition: background-color 0.2s;
        }
        
        .product-item:hover {
            background-color: #f8f9fa;
        }
        
        .product-item:last-child {
            border-bottom: none;
        }
        
        .product-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
            font-size: 14px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            color: #666;
            font-size: 14px;
        }
        
        .info-value {
            font-weight: 500;
            text-align: right;
        }
        
        .card-modern {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        .card-modern .card-header {
            background-color: #fff;
            border-bottom: 2px solid #f0f0f0;
            padding: 20px;
            font-weight: 600;
            border-radius: 12px 12px 0 0;
        }
        
        .card-modern .card-body {
            padding: 20px;
        }
        
        .address-box {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        
        .refund-alert {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
        }
        
        .refund-pending {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .refund-approved {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .btn-action {
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .total-amount {
            font-size: 24px;
            font-weight: 700;
            color: #dc3545;
        }
        
        .discount-tag {
            background-color: #fff3cd;
            color: #856404;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 13px;
            display: inline-block;
        }
        
        .shipping-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div layout:fragment="content" class="order-detail-page">
        <div class="container">
            <!-- Back Button -->
            <div class="mb-3">
                <a th:href="@{/orders}" class="btn btn-link text-decoration-none">
                    <i class="bi bi-arrow-left me-2"></i>
                    <span>Quay lại danh sách đơn hàng</span>
                </a>
            </div>

            <!-- Order Header -->
            <div class="card-modern">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                        <div>
                            <h4 class="mb-2">
                                <i class="bi bi-receipt me-2 text-primary"></i>
                                Đơn hàng #<span th:text="${order.orderId}">ORD20251116001</span>
                            </h4>
                            <div class="text-muted mb-2">
                                <i class="bi bi-clock me-1"></i>
                                Đặt ngày: <span th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}">16/11/2024 14:30</span>
                            </div>
                            <div class="text-muted">
                                <i class="bi bi-shop me-1"></i>
                                Shop: <span th:text="${order.shopName}">Shop ABC</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="status-badge mb-2"
                                 th:classappend="${order.status == 1 ? 'bg-warning text-dark' :
                                                  order.status == 2 ? 'bg-info text-white' :
                                                  order.status == 3 ? 'bg-primary text-white' :
                                                  order.status == 4 ? 'bg-success text-white' :
                                                  order.status == 5 ? 'bg-danger text-white' :
                                                  order.status == 6 ? 'bg-secondary text-white' :
                                                  order.status == 8 ? 'bg-dark text-white' : 'bg-light text-dark'}"
                                 th:text="${order.statusText}">
                                Đang xử lý
                            </div>
                            <div class="small text-muted">
                                <i class="bi bi-credit-card me-1"></i>
                                <span th:text="${order.paymentMethod == 'COD' ? 'Thanh toán khi nhận hàng' : 'Đã thanh toán online'}">COD</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <!-- Timeline -->
                    <div class="card-modern" th:if="${order.status != 5 && order.status != 8}">
                        <div class="card-header">
                            <i class="bi bi-truck me-2"></i>
                            Trạng thái đơn hàng
                        </div>
                        <div class="card-body">
                            <div class="order-timeline">
                                <div class="timeline-item" 
                                     th:classappend="${order.status >= 1 ? 'active' : ''} + ${order.status == 1 ? ' current' : ''}">
                                    <div class="fw-bold">Đơn hàng đã đặt</div>
                                    <small class="text-muted" th:if="${order.orderDate != null}">
                                        <span th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}">16/11/2024 14:30</span>
                                    </small>
                                </div>
                                
                                <div class="timeline-item" 
                                     th:classappend="${order.status >= 2 ? 'active' : ''} + ${order.status == 2 ? ' current' : ''}">
                                    <div class="fw-bold">Đã xác nhận</div>
                                    <small class="text-muted" th:if="${order.confirmedAt != null}">
                                        <span th:text="${#temporals.format(order.confirmedAt, 'dd/MM/yyyy HH:mm')}">16/11/2024 15:00</span>
                                    </small>
                                </div>
                                
                                <div class="timeline-item" 
                                     th:classappend="${order.status >= 3 ? 'active' : ''} + ${order.status == 3 ? ' current' : ''}">
                                    <div class="fw-bold">Đang giao hàng</div>
                                    <small class="text-muted" th:if="${order.shippingAt != null}">
                                        <span th:text="${#temporals.format(order.shippingAt, 'dd/MM/yyyy HH:mm')}">17/11/2024 09:00</span>
                                    </small>
                                    <div class="mt-2" th:if="${order.status == 3 && order.trackingNumber != null}">
                                        <span class="badge bg-primary">
                                            Mã vận đơn: <span th:text="${order.trackingNumber}">TRACK123</span>
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="timeline-item" 
                                     th:classappend="${order.status >= 4 ? 'active' : ''} + ${order.status == 4 ? ' current' : ''}">
                                    <div class="fw-bold">Đã giao hàng</div>
                                    <small class="text-muted" th:if="${order.completedAt != null}">
                                        <span th:text="${#temporals.format(order.completedAt, 'dd/MM/yyyy HH:mm')}">18/11/2024 14:00</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cancelled/Refunded Info -->
                    <div class="card-modern" th:if="${order.status == 5 || order.status == 8}">
                        <div class="card-body">
                            <div class="alert alert-danger mb-0">
                                <h5 class="alert-heading">
                                    <i class="bi bi-x-circle me-2"></i>
                                    <span th:text="${order.status == 5 ? 'Đơn hàng đã bị hủy' : 'Đơn hàng đã được hoàn tiền'}"></span>
                                </h5>
                                <hr>
                                <p class="mb-0">
                                    <strong>Lý do:</strong> <span th:text="${order.cancelReason}">Khách hủy đơn</span>
                                </p>
                                <p class="mb-0 mt-2" th:if="${order.cancelledAt != null}">
                                    <strong>Thời gian:</strong> 
                                    <span th:text="${#temporals.format(order.cancelledAt, 'dd/MM/yyyy HH:mm')}">16/11/2024 16:00</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Product Items -->
                    <div class="card-modern">
                        <div class="card-header">
                            <i class="bi bi-bag-check me-2"></i>
                            Sản phẩm trong đơn hàng
                        </div>
                        <div class="card-body p-0">
                            <div th:if="${order.items != null && !order.items.isEmpty()}">
                                <div th:each="item, iterStat : ${order.items}" 
                                     class="product-item px-3"
                                     th:classappend="${iterStat.last ? '' : 'border-bottom'}">
                                    <div class="d-flex align-items-start gap-3">
                                        <img th:src="${item.productVariantImage}" 
                                             class="product-img"
                                             onerror="this.src='/images/no-image.png'" 
                                             th:alt="${item.productVariantName}"/>
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1" th:text="${item.productName}">Tên sản phẩm</h6>
                                            <div class="text-muted small mb-2">
                                                <span th:text="${item.variantName}">Màu đỏ, Size M</span>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <span class="text-muted">Đơn giá: </span>
                                                    <span th:text="${#numbers.formatDecimal(item.unitPrice, 0, 'POINT', 0, 'COMMA')} + '₫'">100,000₫</span>
                                                </div>
                                                <div>
                                                    <span class="text-muted">x</span>
                                                    <span th:text="${item.quantity}">2</span>
                                                </div>
                                            </div>
                                            
                                            <!-- Refund info for item -->
                                            <div th:if="${item.qtyRefunded > 0}" class="mt-2">
                                                <span class="badge bg-warning text-dark">
                                                    <i class="bi bi-arrow-counterclockwise me-1"></i>
                                                    Đã hoàn <span th:text="${item.qtyRefunded}">1</span> sản phẩm
                                                </span>
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <div class="fw-bold" 
                                                 th:text="${#numbers.formatDecimal(item.finalPrice, 0, 'POINT', 0, 'COMMA')} + '₫'">
                                                200,000₫
                                            </div>
                                            <div th:if="${item.discountAllocated > 0}" class="small text-success mt-1">
                                                Giảm: <span th:text="${#numbers.formatDecimal(item.discountAllocated, 0, 'POINT', 0, 'COMMA')} + '₫'">-10,000₫</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div th:if="${order.items == null || order.items.isEmpty()}" class="p-3">
                                <div class="alert alert-warning mb-0">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    Không có sản phẩm trong đơn hàng
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Refund Request -->
                    <div class="card-modern" th:if="${refunds != null}">
                        <div class="card-header">
                            <i class="bi bi-arrow-counterclockwise me-2"></i>
                            Yêu cầu hoàn tiền / Trả hàng
                        </div>
                        <div class="card-body">
                            <div class="refund-alert"
                                 th:classappend="${refunds.status == 'PENDING' ? 'refund-pending' : 
                                                  refunds.status == 'APPROVED' ? 'refund-approved' : ''}">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0">
                                        <i class="bi bi-info-circle me-2"></i>
                                        Mã yêu cầu: #<span th:text="${refunds.refundId}">RF001</span>
                                    </h5>
                                    <span class="badge bg-white text-dark px-3 py-2">
                                        <span th:text="${refunds.status}">PENDING</span>
                                    </span>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-2">
                                            <small class="opacity-75">Số tiền hoàn</small>
                                            <div class="fs-4 fw-bold">
                                                <span th:text="${#numbers.formatDecimal(refunds.amount, 0, 'POINT', 0, 'COMMA')} + '₫'">300,000₫</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-2">
                                            <small class="opacity-75">Loại hoàn tiền</small>
                                            <div class="fw-bold">
                                                <span th:text="${refunds.refundType == 'full' ? 'Hoàn toàn bộ' : 'Hoàn một phần'}">Hoàn một phần</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <hr class="border-white opacity-25 my-3">
                                
                                <div class="mb-2">
                                    <small class="opacity-75">Lý do hoàn tiền</small>
                                    <div th:text="${refunds.reason}">Sản phẩm bị lỗi</div>
                                </div>
                                
                                <div class="mb-2" th:if="${refunds.refundMethod != null}">
                                    <small class="opacity-75">Phương thức hoàn tiền</small>
                                    <div th:text="${refunds.refundMethod}">Chuyển khoản</div>
                                </div>
                                
                                <div th:if="${refunds.notes != null}">
                                    <small class="opacity-75">Ghi chú</small>
                                    <div th:text="${refunds.notes}">Sẽ hoàn tiền trong 3-5 ngày</div>
                                </div>
                                
                                <div class="mt-3" th:if="${refunds.createdAt != null}">
                                    <small class="opacity-75">
                                        <i class="bi bi-clock me-1"></i>
                                        Yêu cầu lúc: <span th:text="${#temporals.format(refunds.createdAt, 'dd/MM/yyyy HH:mm')}">16/11/2024 15:00</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <!-- Delivery Address -->
                    <div class="card-modern">
                        <div class="card-header">
                            <i class="bi bi-geo-alt me-2"></i>
                            Địa chỉ nhận hàng
                        </div>
                        <div class="card-body">
                            <div class="address-box">
                                <div class="fw-bold mb-2">
                                    <i class="bi bi-person me-1"></i>
                                    <span th:text="${order.recipientName}">Nguyễn Văn A</span>
                                </div>
                                <div class="text-muted mb-2">
                                    <i class="bi bi-telephone me-1"></i>
                                    <span th:text="${order.recipientPhone}">0909123456</span>
                                </div>
                                <div class="text-muted">
                                    <i class="bi bi-house me-1"></i>
                                    <span th:text="${order.deliveryAddress}">123 Đường ABC, Phường 1, Quận 1, TP.HCM</span>
                                </div>
                            </div>
                            
                            <div class="mt-3" th:if="${order.orderNote != null}">
                                <small class="text-muted d-block mb-1">Ghi chú đơn hàng:</small>
                                <div class="alert alert-info py-2 mb-0">
                                    <i class="bi bi-chat-left-quote me-1"></i>
                                    <span th:text="${order.orderNote}">Gọi trước khi giao 15 phút</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Summary -->
                    <div class="card-modern">
                        <div class="card-header">
                            <i class="bi bi-calculator me-2"></i>
                            Chi tiết thanh toán
                        </div>
                        <div class="card-body">
                            <div class="info-row">
                                <span class="info-label">Tạm tính</span>
                                <span class="info-value" th:text="${#numbers.formatDecimal(order.subtotal, 0, 'POINT', 0, 'COMMA')} + '₫'">500,000₫</span>
                            </div>
                            
                            <div class="info-row" th:if="${order.totalDiscount > 0}">
                                <span class="info-label">
                                    <i class="bi bi-tag me-1 text-success"></i>
                                    Giảm giá sản phẩm
                                </span>
                                <span class="info-value text-success">
                                    -<span th:text="${#numbers.formatDecimal(order.totalDiscount, 0, 'POINT', 0, 'COMMA')} + '₫'">50,000₫</span>
                                </span>
                            </div>
                            
                            <div class="info-row" th:if="${order.couponDiscount > 0}">
                                <span class="info-label">
                                    <i class="bi bi-ticket-perforated me-1 text-warning"></i>
                                    Voucher giảm giá
                                </span>
                                <span class="info-value text-success">
                                    -<span th:text="${#numbers.formatDecimal(order.couponDiscount, 0, 'POINT', 0, 'COMMA')} + '₫'">50,000₫</span>
                                </span>
                            </div>
                            
                            <div class="info-row">
                                <span class="info-label">
                                    <i class="bi bi-truck me-1"></i>
                                    Phí vận chuyển
                                </span>
                                <span class="info-value" th:text="${order.shippingFee > 0 ? #numbers.formatDecimal(order.shippingFee, 0, 'POINT', 0, 'COMMA') + '₫' : 'Miễn phí'}">30,000₫</span>
                            </div>
                            
                            <div class="info-row" th:if="${order.refund > 0}">
                                <span class="info-label text-danger">
                                    <i class="bi bi-arrow-counterclockwise me-1"></i>
                                    Đã hoàn tiền
                                </span>
                                <span class="info-value text-danger">
                                    -<span th:text="${#numbers.formatDecimal(order.refund, 0, 'POINT', 0, 'COMMA')} + '₫'">200,000₫</span>
                                </span>
                            </div>
                            
                            <hr class="my-3">
                            
                            <div class="info-row">
                                <span class="fw-bold">Tổng thanh toán</span>
                                <span class="total-amount" th:text="${#numbers.formatDecimal(order.finalAmount, 0, 'POINT', 0, 'COMMA')} + '₫'">480,000₫</span>
                            </div>
                            
                            <div class="mt-3" th:if="${order.discounts != null && !order.discounts.isEmpty()}">
                                <small class="text-muted d-block mb-2">Mã giảm giá đã sử dụng:</small>
                                <div th:each="d : ${order.discounts}" class="mb-2">
                                    <span class="discount-tag">
                                        <i class="bi bi-ticket-perforated me-1"></i>
                                        <span th:text="${d.couponCode}">GIAM50K</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="card-modern">
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <!-- Cancel Order -->
                                <button class="btn btn-outline-danger btn-action" 
                                        th:if="${order.status == 1 || order.status == 2}"
                                        onclick="cancelOrder()">
                                    <i class="bi bi-x-circle me-2"></i>
                                    Hủy đơn hàng
                                </button>
                                
                                <!-- Request Refund -->
                                <button class="btn btn-warning btn-action" 
                                        th:if="${order.status == 4 && (refunds == null || refunds.status == 'REJECTED')}"
                                        onclick="requestRefund()">
                                    <i class="bi bi-arrow-counterclockwise me-2"></i>
                                    Yêu cầu hoàn tiền
                                </button>
                                
                                <!-- Confirm Received -->
                                <button class="btn btn-success btn-action" 
                                        th:if="${order.status == 3}"
                                        onclick="confirmReceived()">
                                    <i class="bi bi-check-circle me-2"></i>
                                    Đã nhận được hàng
                                </button>
                                
                                <!-- Review Order -->
                                <button class="btn btn-primary btn-action" 
                                        th:if="${order.status == 4 && !order.hasReviewed}"
                                        onclick="reviewOrder()">
                                    <i class="bi bi-star me-2"></i>
                                    Đánh giá đơn hàng
                                </button>
                                
                                <!-- Buy Again -->
                                <button class="btn btn-outline-primary btn-action" 
                                        th:if="${order.status == 4}"
                                        onclick="buyAgain()">
                                    <i class="bi bi-arrow-repeat me-2"></i>
                                    Mua lại
                                </button>
                                
                                <!-- Contact Shop -->
                                <button class="btn btn-outline-secondary btn-action"
                                        onclick="contactShop()">
                                    <i class="bi bi-chat-dots me-2"></i>
                                    Liên hệ Shop
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script layout:fragment="scripts">
        function cancelOrder() {
            if(confirm('Bạn có chắc muốn hủy đơn hàng này?')) {
                // Call API to cancel order
                console.log('Cancel order');
            }
        }
        
        function requestRefund() {
            // Redirect to refund request page
            console.log('Request refund');
        }
        
        function confirmReceived() {
            if(confirm('Xác nhận đã nhận được hàng?')) {
                // Call API to confirm
                console.log('Confirm received');
            }
        }
        
        function reviewOrder() {
            // Redirect to review page
            console.log('Review order');
        }
        
        function buyAgain() {
            // Add items to cart
            console.log('Buy again');
        }
        
        function contactShop() {
            // Open chat with shop
            console.log('Contact shop');
        }
    </script>
</body>
</html>